<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerar Notifica√ß√£o - Dashboard</title>
    <style>
    /* --- VARI√ÅVEIS --- */
    :root {
        --primary-color: #0077cc;
        --primary-hover: #005fa3;
        --bg-body: #c7c9c9;
        --bg-card: #ffffff;
        --text-main: #1f1d1d;
        --border-color: #dcdde6;
        --input-bg: #d8e2e3;
        --font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        --border-radius: 8px;
        --drop-zone-bg: #f8f9fa;
        --drop-zone-border: #cbd5e0;
    }

    /* Temas */
    body.theme-gold { --primary-color: #b8860b; --primary-hover: #8b6508; }
    body.theme-pink { --primary-color: #e91e63; --primary-hover: #c2185b; }
    body.theme-purple { --primary-color: #9c27b0; --primary-hover: #7b1fa2; }
    
    body.theme-dark {
        --primary-color: #4a9eff; --primary-hover: #0077cc;
        --bg-body: #121212; --bg-card: #1e1e1e;
        --text-main: #e0e0e0; --border-color: #333;
        --input-bg: #2d2d2d; --drop-zone-bg: #252525; --drop-zone-border: #444;
    }

    html, body {
        height: 100%; margin: 0; padding: 0; overflow: hidden;
        font-family: var(--font-family); background: var(--bg-body); color: var(--text-main);
    }

    #container { display: flex; height: 100vh; padding: 11px; box-sizing: border-box; gap: 15px; }

    .form-container {
        background: var(--bg-card); padding: 10px; border-radius: var(--border-radius);
        width: 480px; min-width: 350px; box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        display: flex; flex-direction: column; overflow-y: auto; height: 100%; box-sizing: border-box;
    }

    .form-container::-webkit-scrollbar { width: 8px; }
    .form-container::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.2); border-radius: 4px; }

    .preview-container { flex-grow: 1; display: flex; flex-direction: column; height: 100%; min-width: 0; }

    #previewFrame { 
        flex-grow: 1; width: 100%; border: none; border-radius: var(--border-radius);
        background: #525659; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    @media (max-width: 800px) {
        html, body { overflow: auto; height: auto; }
        #container { flex-direction: column; height: auto; }
        .form-container { width: 100%; height: auto; overflow-y: visible; }
        .preview-container { height: 600px; }
    }

    .theme-selector { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
    .theme-selector select { padding: 2px 4px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-main); cursor: pointer; }

    fieldset { border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 8px; margin-bottom: 8px; }
    legend { font-weight: bold; padding: 0 3px; color: var(--primary-color); }
    label { display: block; margin-top: 5px; font-weight: 500; font-size: 0.9rem; }

    input:not([type="checkbox"]), textarea, select {
        width: 100%; padding: 5px; margin-top: 3px; border: 1px solid var(--border-color);
        background: var(--input-bg); color: var(--text-main); border-radius: 6px; box-sizing: border-box;
        font-size: 0.95rem; transition: border-color 0.2s;
    }
    input:focus, textarea:focus { outline: none; border-color: var(--primary-color); }

    button {
        padding: 6px 12px; border: none; background: var(--primary-color); color: #fff;
        border-radius: 6px; cursor: pointer; transition: all 0.2s;
        font-weight: 500; font-size: 0.95rem; margin-top: 10px;
    }
    button:hover { background: var(--primary-hover); transform: translateY(-1px); }

    .checkbox-label { display: flex !important; align-items: flex-start; margin-top: 8px !important; cursor: pointer; font-size: 0.9rem; }
    .checkbox-label input[type="checkbox"] { width: 14px !important; height: 18px; margin-right: 10px; margin-top: 2px; flex-shrink: 0; cursor: pointer; }

    .drop-zone {
        border: 2px dashed var(--drop-zone-border); border-radius: var(--border-radius);
        padding: 10px; text-align: center; background: var(--drop-zone-bg);
        transition: all 0.2s ease; cursor: pointer; position: relative;
    }
    .drop-zone:hover, .drop-zone.drag-over { border-color: var(--primary-color); background: rgba(0, 119, 204, 0.05); }
    .drop-zone input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

    .img-tag { background: var(--primary-color); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; margin-top: 5px; display: inline-block; }

    .button-row { 
        display: flex; gap: 6px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; 
        background: var(--bg-card); padding: 8px; border-radius: var(--border-radius);
        border: 1px solid var(--border-color); flex-shrink: 0;
    }
    
    #messageBox { margin-top: 10px; padding: 10px; border-radius: var(--border-radius); background: #fdd; color: #900; display: none; text-align: center; font-size: 0.9rem; }
    #statusIndicator { font-size: 0.85rem; color: #0077cc; margin-left: auto; font-style: italic; }

    </style>
</head>
<body>

<div id="container">
  <div class="form-container">
    <fieldset>
      <legend>Dados da Notifica√ß√£o</legend>
      <label>Telefone(s):</label>
      <input type="tel" id="telefone" placeholder="(44) 99999-9999" class="auto-update">
      <label>Nome(s):</label>
      <input type="text" id="nomeContato" placeholder="Nome completo" class="auto-update">
      <label>Endere√ßo:</label>
      <input type="text" id="endereco" placeholder="Endere√ßo completo" class="auto-update">
      <label>Ocorr√™ncia:</label>
      <textarea id="ocorrencia" rows="4" placeholder="Parecer..." class="auto-update"></textarea>
      
      <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border-color);">
        <label style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 6px;">Frases R√°pidas</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <label class="checkbox-label" style="margin-top: 0 !important;">
                <input type="checkbox" class="presetPhrase" data-text="Contato realizado via WhatsApp com , onde foi enviada a notifica√ß√£o. Comprovante em anexo."> WhatsApp enviado
            </label>
            <label class="checkbox-label" style="margin-top: 0 !important;">
                <input type="checkbox" class="presetPhrase" data-text="Cadastro incompleto. Ap√≥s tr√™s tentativas de entrega nos dias, foi deixada a notifica√ß√£o. Comprovante em anexo."> Cadastro incompleto
            </label>
            <label class="checkbox-label" style="margin-top: 0 !important;">
                <input type="checkbox" class="presetPhrase" data-text="Terreno baldio, n√£o foi poss√≠vel localizar herdeiro(a) ou atual propriet√°rio. Comprovante em anexo."> Terreno baldio
            </label>
            <label class="checkbox-label" style="margin-top: 0 !important;">
                <input type="checkbox" class="presetPhrase" data-text="Contribuinte recusou receber a notifica√ß√£o. Comprovante em anexo."> Recusa
            </label>
            <label class="checkbox-label" style="margin-top: 0 !important; grid-column: span 2;">
                <input type="checkbox" class="presetPhrase" data-text="Tentativa de contato via WhatsApp sem sucesso e n√£o encontrada empresa/socio no endere√ßo cadastrado. N√£o foi poss√≠vel notificar."> Empresa fechada
            </label>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Arquivo PDF Original</legend>
      <div class="drop-zone" id="pdfDropZone">
          <input type="file" id="fileInput" accept="application/pdf">
          <div style="font-size: 16px;"></div>
          <p><strong>Clique ou Arraste</strong><br> PDF aqui</p>
      </div>
      <div id="fileInfo" style="margin-top: 8px; font-size: 0.85rem; color: #2e7d32; font-weight: bold; display: none;">Arquivo carregado!</div>
    </fieldset>

    <fieldset>
      <legend>Anexos</legend>
      <div class="drop-zone" id="imgDropZone">
          <input type="file" id="imgInput" accept="image/*" multiple>
          <div style="font-size: 16px;"></div>
          <p><strong>Clique ou Arraste</strong><br>Imagens aqui</p>
      </div>
      <div id="imgListContainer" style="margin-top: 8px;"></div>
    </fieldset>

    <div id="messageBox"></div>
    <div style="margin-top: auto; padding-top: 6px;">
        <button id="clearBtn" style="width: 100%; background: #d32f2f;">Limpar Tudo</button>
    </div>
  </div>

  <div class="preview-container">
    <div class="button-row">
      <button id="previewBtn" style="margin:0;">üîÑ Atualizar</button>
      <button id="downloadBtn" style="margin:0; background: #2e7d32;">üíæ Download</button>
      <span id="statusIndicator"></span>
      <div class="theme-selector">
        <select id="themeSelect">
            <option value="default">üîµ Azul (Padr√£o)</option>
            <option value="gold">üü° Dourado</option>
            <option value="pink">üå∏ Rosa</option>
            <option value="purple">üü£ Roxo</option>
            <option value="dark">üåë Modo Escuro</option>
        </select>
      </div>
    </div>
    <iframe id="previewFrame"></iframe>
  </div>
</div>

<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    let pdfJsDoc = null;
    const AppState = { pdfBuffer: null, images: [], isProcessing: false };
    // Recupera o tema salvo ao carregar a p√°gina
    const savedTheme = localStorage.getItem('selectedTheme');
    if (savedTheme) {
    document.getElementById('themeSelect').value = savedTheme;
    document.body.className = savedTheme === 'default' ? '' : 'theme-' + savedTheme;
    }
    const CONFIG = {
      margins: { left: 41, right: 41, top: 30, bottom: 40 },
      fontSize: { title: 11, label: 10, content: 10 },
      spacing: { label: 12 },
      maxRectHeight: 160
    };

    function showMessage(msg, isError = true) {
      const box = document.getElementById("messageBox");
      box.textContent = msg;
      box.style.background = isError ? "#fdd" : "#dfd";
      box.style.color = isError ? "#900" : "#050";
      box.style.display = "block";
      setTimeout(() => box.style.display = "none", 4000);
    }

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    function setStatus(msg) {
        const indicator = document.getElementById('statusIndicator');
        const btn = document.getElementById('previewBtn');
        indicator.textContent = msg;
        btn.textContent = msg ? "‚è≥..." : "üîÑ Atualizar";
    }

    async function loadPdfFile(file) {
    if (!file || file.type !== 'application/pdf') {
        showMessage("Selecione um PDF v√°lido.");
        return;
    }
    try {
        AppState.pdfBuffer = await file.arrayBuffer();

        // üîπ pdf.js (leitura de texto)
        pdfJsDoc = await pdfjsLib.getDocument({ data: AppState.pdfBuffer }).promise;

        document.getElementById("fileInfo").style.display = "block";
        document.getElementById("fileInfo").textContent = `‚úÖ ${file.name}`;
        triggerPreviewUpdate();
    } catch (e) {
        showMessage("Erro: " + e.message);
      }
  }
     async function findTextPosition(pdf, searchText) {
    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const textContent = await page.getTextContent();

        for (let item of textContent.items) {
            if (item.str && item.str.includes(searchText)) {
                return {
                    page: pageNum - 1,
                    x: item.transform[4],
                    y: item.transform[5]
                };
            }
        }
    }
    return null;
    }

    function handleImageFiles(files) {
        const newFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
        AppState.images.push(...newFiles);
        const container = document.getElementById('imgListContainer');
        container.innerHTML = '';
        AppState.images.forEach(img => {
            const tag = document.createElement('span');
            tag.className = 'img-tag';
            tag.textContent = img.name;
            container.appendChild(tag);
        });
        triggerPreviewUpdate();
    } 
  
    // Gerar PDF

   async function gerarPdfBytes() {
        if (!AppState.pdfBuffer) throw new Error("PDF base n√£o carregado.");

        const pdfDoc = await PDFLib.PDFDocument.load(AppState.pdfBuffer);

        // 1Ô∏è‚É£ Mant√©m somente a primeira p√°gina do original
        while (pdfDoc.getPageCount() > 1) {
            pdfDoc.removePage(1);
        }

        const page1 = pdfDoc.getPages()[0];
        const { width, height } = page1.getSize();

        const fontBold = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
        const fontRegular = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

        // ======================================================
        // üîí LOCALIZA FRASE E ANCORA O QUADRO ABAIXO DELA
        // ======================================================
        const phrase = "Ger√™ncia de Valores em Carteira e Cobran√ßa/SEFIN-GCCOB";
        
        // CORRE√á√ÉO: Declarar anchorY com um valor padr√£o (fallback)
        let anchorY = height - 120; 

        if (pdfJsDoc) {
            const pos = await findTextPosition(pdfJsDoc, phrase);
            // pdf-lib usa coordenadas de baixo para cima, pdf.js tamb√©m.
            if (pos && pos.page === 0) {
                anchorY = pos.y - 12; // espa√ßo abaixo da frase detectada
            } 
        }

        const rectWidth = width - (CONFIG.margins.left * 2);
        const rectX = CONFIG.margins.left;
        const rectY = anchorY - CONFIG.maxRectHeight;

        page1.drawRectangle({
            x: rectX,
            y: rectY,
            width: rectWidth,
            height: CONFIG.maxRectHeight,
            borderWidth: 1,
            borderColor: PDFLib.rgb(0, 0, 0),
            color: PDFLib.rgb(1, 1, 1)
        });

        const title = "ENTREGA DE NOTIFICA√á√ïES - PROTESTO";
        const titleWidth = fontBold.widthOfTextAtSize(title, 11);

        page1.drawText(title, {
            x: rectX + (rectWidth - titleWidth) / 2,
            y: rectY + CONFIG.maxRectHeight - 20,
            size: 11,
            font: fontBold
        });

        // CORRE√á√ÉO: Usar document.getElementById para os valores
        const fields = [
            { label: "Telefone(s):", value: document.getElementById('telefone').value },
            { label: "Nome(s):", value: document.getElementById('nomeContato').value },
            { label: "Endere√ßo:", value: document.getElementById('endereco').value },
            { label: "Ocorr√™ncia/Parecer:", value: document.getElementById('ocorrencia').value }
        ].filter(f => f.value.trim());

        let yCursorText = rectY + CONFIG.maxRectHeight - 40;

        fields.forEach(f => {
            page1.drawText(f.label, {
                x: rectX + 10,
                y: yCursorText,
                size: 10,
                font: fontBold
            });

            page1.drawText(f.value, {
                x: rectX + 110,
                y: yCursorText,
                size: 10,
                font: fontRegular,
                maxWidth: rectWidth - 120
            });

            yCursorText -= 14;
        });

        // 3Ô∏è‚É£ IMAGENS ‚Äî 2 POR P√ÅGINA (EMPILHADAS)
        if (AppState.images.length > 0) {
            let lastUsedPageIndex = 0;
            let currentPage = null;
            let imageIndexOnPage = 0;
            let imgY = 0;

            const imgMaxWidth = width - (CONFIG.margins.left * 2);
            const imgMaxHeight = (height - 120) / 2;

            for (let i = 0; i < AppState.images.length; i++) {
                if (imageIndexOnPage === 0) {
                    currentPage = pdfDoc.addPage([width, height]);
                    lastUsedPageIndex = pdfDoc.getPageCount() - 1;
                    imgY = height - 60;
                }

                const imgBytes = await AppState.images[i].arrayBuffer();
                const img = AppState.images[i].type === "image/png"
                    ? await pdfDoc.embedPng(imgBytes)
                    : await pdfDoc.embedJpg(imgBytes);

                const scale = Math.min(
                    imgMaxWidth / img.width,
                    imgMaxHeight / img.height
                );

                const imgW = img.width * scale;
                const imgH = img.height * scale;

                currentPage.drawImage(img, {
                    x: (width - imgW) / 2,
                    y: imgY - imgH,
                    width: imgW,
                    height: imgH
                });

                imgY -= imgH + 20;
                imageIndexOnPage++;

                if (imageIndexOnPage === 2) {
                    imageIndexOnPage = 0;
                }
            }
        }

        return await pdfDoc.save();
    }


    const triggerPreviewUpdate = debounce(async () => {
        if (!AppState.pdfBuffer) return;
        try {
            setStatus("Gerando...");
            const pdfBytes = await gerarPdfBytes();
            const blob = new Blob([pdfBytes], {type: "application/pdf"});
            const url = URL.createObjectURL(blob);
            document.getElementById("previewFrame").src = url;
        } catch (e) { console.error(e); } 
        finally { setStatus(""); }
    }, 800);

    // Eventos
    document.querySelectorAll('.auto-update').forEach(input => input.addEventListener('input', triggerPreviewUpdate));
    document.getElementById("pdfDropZone").addEventListener('drop', (e) => { e.preventDefault(); loadPdfFile(e.dataTransfer.files[0]); });
    document.getElementById("fileInput").addEventListener('change', (e) => loadPdfFile(e.target.files[0]));
    document.getElementById("imgDropZone").addEventListener('drop', (e) => { e.preventDefault(); handleImageFiles(e.dataTransfer.files); });
    document.getElementById("imgInput").addEventListener('change', (e) => handleImageFiles(e.target.files));
    
    document.querySelectorAll('.presetPhrase').forEach(cb => {
        cb.addEventListener('change', () => {
            const textArea = document.getElementById('ocorrencia');
            const selected = Array.from(document.querySelectorAll('.presetPhrase:checked')).map(c => c.dataset.text);
            textArea.value = selected.join('\n');
            textArea.dispatchEvent(new Event('input'));
        });
    });

    document.getElementById("downloadBtn").addEventListener("click", async () => {
        try {
            const bytes = await gerarPdfBytes();
            const blob = new Blob([bytes], { type: "application/pdf" });
            const fileName = "Notificacao_Gerada.pdf";

            // Verifica se o navegador suporta a API de escolha de arquivo
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{
                            description: 'Documento PDF',
                            accept: { 'application/pdf': ['.pdf'] },
                        }],
                    });
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    return; // Sucesso com a janela de escolha
                } catch (err) {
                    // Se o usu√°rio cancelar a janela, n√£o faz nada
                    if (err.name === 'AbortError') return;
                    console.error("Erro ao usar FilePicker, tentando fallback...", err);
                }
            }

            // Fallback: M√©todo tradicional (baixa direto para a pasta padr√£o)
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
            setTimeout(() => URL.revokeObjectURL(link.href), 100);
            
        } catch (e) { 
            showMessage("Erro ao baixar: " + e.message); 
        }
    });

    document.getElementById("clearBtn").addEventListener("click", () => location.reload());

    // Mascaras e Capitaliza√ß√£o
    document.getElementById('telefone').addEventListener('input', function(e){
        let v = e.target.value.replace(/\D/g,'');
        if(v.length>11) v=v.slice(0,11);
        if(v.length>10) e.target.value=`(${v.slice(0,2)}) ${v.slice(2,7)}-${v.slice(7)}`;
        else if(v.length>2) e.target.value=`(${v.slice(0,2)}) ${v.slice(2)}`;
    });

    ['nomeContato', 'endereco'].forEach(id => {
        document.getElementById(id).addEventListener('input', function() {
            this.value = this.value.replace(/(?:^|\s)\S/g, a => a.toUpperCase());
        });
    });

    // Salva e aplica o tema ao mudar o select
document.getElementById('themeSelect').addEventListener('change', (e) => {
    const selectedTheme = e.target.value;
    
    // Aplica o tema visualmente
    document.body.className = selectedTheme === 'default' ? '' : 'theme-' + selectedTheme;
    
    // Salva a escolha no navegador
    localStorage.setItem('selectedTheme', selectedTheme);
    });
});
</script>
</body>
</html>


