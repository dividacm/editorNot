<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerar Notifica√ß√£o - Dashboard</title>
    <style>
    /* --- VARI√ÅVEIS PADR√ÉO --- */
    :root {
        --primary-color: #0077cc;
        --primary-hover: #005fa3;
        --bg-body: #c7c9c9;
        --bg-card: #ffffff;
        --text-main: #1f1d1d;
        --border-color: #dcdde6;
        --input-bg: #d8e2e3;
        --font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        --border-radius: 8px;
        --drop-zone-bg: #f8f9fa;
        --drop-zone-border: #cbd5e0;
    }

    /* --- TEMAS PERSONALIZADOS --- */
    
    body.theme-gold { --primary-color: #b8860b; --primary-hover: #8b6508; }
    body.theme-pink { --primary-color: #e91e63; --primary-hover: #c2185b; }
    body.theme-purple { --primary-color: #9c27b0; --primary-hover: #7b1fa2; }
    
    /* --- TEMA PALMEIRAS (VERD√ÉO) --- */
    body.theme-palmeiras { 
        --primary-color: #006437; 
        --primary-hover: #044427; 
        --bg-body: #d1e7dd; /* Fundo verde suave */
        --bg-card: #ffffff;
        --border-color: #badbcc;  
        --input-bg: #f8fcf9;      
        --drop-zone-border: #006437;
    }
    
    /* Escudo na barra de bot√µes - PALMEIRAS */
    body.theme-palmeiras .button-row {
        background-image: url('https://upload.wikimedia.org/wikipedia/commons/1/10/Palmeiras_logo.svg');
        background-repeat: no-repeat;
        background-position: right 15px center; /* Alinhado √† direita com margem */
        background-size: 42px; /* Tamanho do escudo */
        padding-right: 70px; /* Empurra os bot√µes para n√£o cobrir o escudo */
        border: 1px solid #006437;
    }

    /* --- TEMA S√ÉO PAULO (TRICOLOR) --- */
    body.theme-saopaulo { 
        --primary-color: #df2128; 
        --primary-hover: #000000; 
        --bg-body: #a81826;       
        --bg-card: #ffffff;
        --text-main: #000000;     
        --border-color: #000000;  
        --input-bg: #fff5f5;      
        --drop-zone-border: #df2128;
    }

    /* Escudo na barra de bot√µes - S√ÉO PAULO */
    body.theme-saopaulo .button-row {
        background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Brasao_do_Sao_Paulo_Futebol_Clube.svg/1024px-Brasao_do_Sao_Paulo_Futebol_Clube.svg.png');
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 40px;
        padding-right: 70px;
        border-top: 3px solid #df2128;
        border-bottom: 3px solid #000000;
        border-left: 1px solid #dcdde6;
        border-right: 1px solid #dcdde6;
    }
    
    body.theme-saopaulo .form-container {
        border-top: 4px solid #df2128;
        border-bottom: 4px solid #000000;
    }

    body.theme-dark {
        --primary-color: #4a9eff; --primary-hover: #0077cc;
        --bg-body: #121212; --bg-card: #1e1e1e;
        --text-main: #e0e0e0; --border-color: #333;
        --input-bg: #2d2d2d; --drop-zone-bg: #252525; --drop-zone-border: #444;
    }

    /* --- ESTILOS GERAIS --- */
    html, body {
        height: 100%; margin: 0; padding: 0; overflow: hidden;
        font-family: var(--font-family); background-color: var(--bg-body); color: var(--text-main);
        transition: background 0.3s ease;
    }
    
    #container { display: flex; height: 100vh; padding: 11px; box-sizing: border-box; gap: 15px; }
    
    .form-container {
        background: var(--bg-card); padding: 10px; border-radius: var(--border-radius);
        width: 480px; min-width: 350px; box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        display: flex; flex-direction: column; overflow-y: auto; height: 100%; box-sizing: border-box;
        border: 1px solid var(--border-color);
    }
    .form-container::-webkit-scrollbar { width: 8px; }
    .form-container::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.2); border-radius: 4px; }
    
    .preview-container { flex-grow: 1; display: flex; flex-direction: column; height: 100%; min-width: 0; }
    #previewFrame { flex-grow: 1; width: 100%; border: none; border-radius: var(--border-radius); background: #525659; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

    .button-row { 
        display: flex; gap: 6px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; 
        background: var(--bg-card); padding: 8px; border-radius: var(--border-radius);
        border: 1px solid var(--border-color); flex-shrink: 0;
        transition: all 0.3s ease;
    }

    @media (max-width: 800px) {
        html, body { overflow: auto; height: auto; }
        #container { flex-direction: column; height: auto; }
        .form-container { width: 100%; height: auto; overflow-y: visible; }
        .preview-container { height: 600px; }
    }
    
    .theme-selector { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
    .theme-selector select { padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-main); cursor: pointer; font-weight: bold; }

    fieldset { border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 8px; margin-bottom: 8px; }
    legend { font-weight: bold; padding: 0 3px; color: var(--primary-color); }
    label { display: block; margin-top: 5px; font-weight: 600; font-size: 0.9rem; }
    
    input:not([type="checkbox"]), textarea, select {
        width: 100%; padding: 5px; margin-top: 3px; border: 1px solid var(--border-color);
        background: var(--input-bg); color: var(--text-main); border-radius: 6px; box-sizing: border-box;
        font-size: 0.95rem; transition: border-color 0.2s;
    }
    input:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(0,0,0,0.05); }
    
    button { padding: 6px 12px; border: none; background: var(--primary-color); color: #fff; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-weight: 500; font-size: 0.95rem; margin-top: 10px; }
    button:hover { background: var(--primary-hover); transform: translateY(-1px); }
    
    .checkbox-label { display: flex !important; align-items: flex-start; margin-top: 8px !important; cursor: pointer; font-size: 0.9rem; }
    .checkbox-label input[type="checkbox"] { width: 14px !important; height: 18px; margin-right: 10px; margin-top: 2px; flex-shrink: 0; cursor: pointer; }
    
    .drop-zone { border: 2px dashed var(--drop-zone-border); border-radius: var(--border-radius); padding: 10px; text-align: center; background: var(--drop-zone-bg); transition: all 0.2s ease; cursor: pointer; position: relative; }
    .drop-zone:hover, .drop-zone.drag-over { border-color: var(--primary-color); background: rgba(0, 0, 0, 0.05); }
    .drop-zone input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    
    .img-tag { background: var(--primary-color); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; margin-top: 5px; display: inline-block; }
    
    #messageBox { margin-top: 10px; padding: 10px; border-radius: var(--border-radius); background: #fdd; color: #900; display: none; text-align: center; font-size: 0.9rem; }
    #statusIndicator { font-size: 0.85rem; color: var(--primary-color); margin-left: auto; font-style: italic; font-weight: bold; }
    </style>
</head>
<body>

<div id="container">
  <div class="form-container">
    <fieldset>
      <legend>Dados da Notifica√ß√£o</legend>
      <label>Telefone(s):</label>
      <input type="tel" id="telefone" placeholder="(44) 99999-9999" class="auto-update">
      <label>Nome(s):</label>
      <input type="text" id="nomeContato" placeholder="Nome completo" class="auto-update">
      <label>Endere√ßo:</label>
      <input type="text" id="endereco" placeholder="Endere√ßo completo" class="auto-update">
      <label>Ocorr√™ncia:</label>
      <textarea id="ocorrencia" rows="4" placeholder="Parecer..." class="auto-update"></textarea>
      
      <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border-color);">
        <label style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 6px;">Frases R√°pidas</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <label class="checkbox-label" style="margin-top: 0 !important;">
                <input type="checkbox" class="presetPhrase" data-text="Contato realizado via WhatsApp com , onde foi enviada a notifica√ß√£o. Comprovante em anexo."> WhatsApp enviado
            </label>
            <label class="checkbox-label" style="margin-top: 0 !important;">
                <input type="checkbox" class="presetPhrase" data-text="Cadastro incompleto. Ap√≥s tr√™s tentativas de entrega nos dias, foi deixada a notifica√ß√£o. Comprovante em anexo."> Cadastro incompleto
            </label>
            <label class="checkbox-label" style="margin-top: 0 !important;">
                <input type="checkbox" class="presetPhrase" data-text="Terreno baldio, n√£o foi poss√≠vel localizar herdeiro(a) ou atual propriet√°rio. Comprovante em anexo."> Terreno baldio
            </label>
            <label class="checkbox-label" style="margin-top: 0 !important;">
                <input type="checkbox" class="presetPhrase" data-text="Contribuinte recusou receber a notifica√ß√£o. Comprovante em anexo."> Recusa
            </label>
            <label class="checkbox-label" style="margin-top: 0 !important; grid-column: span 2;">
                <input type="checkbox" class="presetPhrase" data-text="Tentativa de contato via WhatsApp sem sucesso e n√£o encontrada empresa/socio no endere√ßo cadastrado. N√£o foi poss√≠vel notificar."> Empresa fechada
            </label>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Arquivo PDF Original</legend>
      <div class="drop-zone" id="pdfDropZone">
          <input type="file" id="fileInput" accept="application/pdf">
          <div style="font-size: 16px;"></div>
          <p><strong>Clique ou Arraste</strong><br> PDF aqui</p>
      </div>
      <div id="fileInfo" style="margin-top: 8px; font-size: 0.85rem; color: #2e7d32; font-weight: bold; display: none;">Arquivo carregado!</div>
    </fieldset>

    <fieldset>
      <legend>Anexos</legend>
      <div class="drop-zone" id="imgDropZone">
          <input type="file" id="imgInput" accept="image/*" multiple>
          <div style="font-size: 16px;"></div>
          <p><strong>Clique ou Arraste</strong><br>Imagens aqui</p>
      </div>
      <div id="imgListContainer" style="margin-top: 8px;"></div>
    </fieldset>

    <div id="messageBox"></div>
    <div style="margin-top: auto; padding-top: 6px;">
        <button id="clearBtn" style="width: 100%; background: #d32f2f;">Limpar Tudo</button>
    </div>
  </div>

  <div class="preview-container">
    <div class="button-row">
      <button id="previewBtn" style="margin:0;">üîÑ Atualizar</button>
      <button id="downloadBtn" style="margin:0; background: #2e0404;">üíæ Download</button>
      <span id="statusIndicator"></span>
      <div class="theme-selector">
        <select id="themeSelect">
            <option value="default">üîµ Padr√£o</option>
            <option value="gold">üü° Dourado</option>
            <option value="pink">üå∏ Rosa</option>
            <option value="purple">üü£ Roxo</option>
            <option value="palmeiras">üê∑ Verd√£o</option>
            <option value="saopaulo">Tricolor</option>
            <option value="dark">üåë Modo Escuro</option>
        </select>
      </div>
    </div>
    <iframe id="previewFrame"></iframe>
  </div>
</div>

<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    let pdfJsDoc = null;
    const AppState = { 
        pdfBuffer: null, 
        pdfName: "Notificacao.pdf", 
        images: [], 
        isProcessing: false 
    };

    // --- TEMAS ---
    const themeSelect = document.getElementById('themeSelect');
    const applyTheme = (themeName) => {
        document.body.className = '';
        if (themeName !== 'default') {
            document.body.classList.add('theme-' + themeName);
        }
    };
    const savedTheme = localStorage.getItem('selectedTheme');
    if (savedTheme) { themeSelect.value = savedTheme; applyTheme(savedTheme); }
    themeSelect.addEventListener('change', (e) => {
        applyTheme(e.target.value);
        localStorage.setItem('selectedTheme', e.target.value);
    });

    // --- CONFIGURA√á√ÉO PDF ---
    const CONFIG = {
      margins: { left: 41, right: 41, top: 30, bottom: 40 },
      fontSize: { title: 11, label: 10, content: 10 },
      maxRectHeight: 160
    };

    function showMessage(msg, isError = true) {
      const box = document.getElementById("messageBox");
      box.textContent = msg;
      box.style.background = isError ? "#fdd" : "#dfd";
      box.style.color = isError ? "#900" : "#050";
      box.style.display = "block";
      setTimeout(() => box.style.display = "none", 4000);
    }

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    function setStatus(msg) {
        const indicator = document.getElementById('statusIndicator');
        const btn = document.getElementById('previewBtn');
        indicator.textContent = msg;
        btn.textContent = msg ? "‚è≥..." : "üîÑ Atualizar";
    }

    async function loadPdfFile(file) {
        if (!file || file.type !== 'application/pdf') { showMessage("Selecione um PDF v√°lido."); return; }
        try {
            AppState.pdfBuffer = await file.arrayBuffer();
            AppState.pdfName = file.name; 
            pdfJsDoc = await pdfjsLib.getDocument({ data: AppState.pdfBuffer }).promise;
            document.getElementById("fileInfo").style.display = "block";
            document.getElementById("fileInfo").textContent = `‚úÖ ${file.name}`;
            triggerPreviewUpdate();
        } catch (e) { showMessage("Erro: " + e.message); }
    }

    async function findTextPosition(pdf, searchText) {
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const textContent = await page.getTextContent();
            for (let item of textContent.items) {
                if (item.str && item.str.includes(searchText)) {
                    return { page: pageNum - 1, x: item.transform[4], y: item.transform[5] };
                }
            }
        }
        return null;
    }

    function handleImageFiles(files) {
        const newFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
        AppState.images.push(...newFiles);
        const container = document.getElementById('imgListContainer');
        container.innerHTML = '';
        AppState.images.forEach(img => {
            const tag = document.createElement('span');
            tag.className = 'img-tag';
            tag.textContent = img.name;
            container.appendChild(tag);
        });
        triggerPreviewUpdate();
    }

    // --- L√ìGICA PRINCIPAL DE GERA√á√ÉO ---
    async function gerarPdfBytes() {
        if (!AppState.pdfBuffer) throw new Error("PDF base n√£o carregado.");
        const pdfDoc = await PDFLib.PDFDocument.load(AppState.pdfBuffer);
        
        // Mant√©m apenas a p√°gina 1 original
        while (pdfDoc.getPageCount() > 1) { pdfDoc.removePage(1); }

        const fontBold = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
        const fontRegular = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

        // -- 1. Localizar Frase --
        const phrase = "Ger√™ncia de Valores em Carteira e Cobran√ßa/SEFIN-GCCOB";
        let foundOnPage1 = false;
        let anchorY = 0;

        if (pdfJsDoc) {
            const pos = await findTextPosition(pdfJsDoc, phrase);
            if (pos && pos.page === 0) {
                foundOnPage1 = true;
                anchorY = pos.y - 12; // Espa√ßo abaixo da frase
            }
        }

        const width = pdfDoc.getPages()[0].getWidth();
        const height = pdfDoc.getPages()[0].getHeight();

        // -- 2. Definir onde desenhar o quadro --
        let boxPage;
        let boxRectY;

        if (foundOnPage1) {
            // Cen√°rio A: Achou na pag 1 -> Desenha nela
            boxPage = pdfDoc.getPages()[0];
            boxRectY = anchorY - CONFIG.maxRectHeight;
        } else {
            // Cen√°rio B: N√£o achou -> Cria pag 2 e desenha no topo
            boxPage = pdfDoc.addPage([width, height]);
            boxRectY = height - CONFIG.margins.top - CONFIG.maxRectHeight;
        }

        // -- 3. Desenhar o Quadro (Fun√ß√£o Helper) --
        const drawNotificationBox = (page, x, y) => {
            const rectWidth = width - (CONFIG.margins.left * 2);
            
            // Fundo Branco
            page.drawRectangle({
                x: x, y: y, width: rectWidth, height: CONFIG.maxRectHeight,
                borderWidth: 1, borderColor: PDFLib.rgb(0, 0, 0), color: PDFLib.rgb(1, 1, 1)
            });

            // T√≠tulo
            const title = "ENTREGA DE NOTIFICA√á√ïES - PROTESTO";
            const titleWidth = fontBold.widthOfTextAtSize(title, 11);
            page.drawText(title, {
                x: x + (rectWidth - titleWidth) / 2,
                y: y + CONFIG.maxRectHeight - 20,
                size: 11, font: fontBold
            });

            // Campos
            const fields = [
                { label: "Telefone(s):", value: document.getElementById('telefone').value },
                { label: "Nome(s):", value: document.getElementById('nomeContato').value },
                { label: "Endere√ßo:", value: document.getElementById('endereco').value },
                { label: "Ocorr√™ncia/Parecer:", value: document.getElementById('ocorrencia').value }
            ].filter(f => f.value.trim());

            let yCursorText = y + CONFIG.maxRectHeight - 40;
            fields.forEach(f => {
                page.drawText(f.label, { x: x + 10, y: yCursorText, size: 10, font: fontBold });
                
                // Desenha o valor com lineHeight ajustado
                page.drawText(f.value, { 
                    x: x + 110, 
                    y: yCursorText, 
                    size: 10, 
                    font: fontRegular, 
                    maxWidth: rectWidth - 120,
                    lineHeight: 12 // <--- Espa√ßamento entre linhas reduzido
                });
                
                yCursorText -= 14;
            });
        };

        // Executa o desenho do quadro
        drawNotificationBox(boxPage, CONFIG.margins.left, boxRectY);

        // -- 4. Desenhar Imagens --
        if (AppState.images.length > 0) {
            let currentPage;
            let currentYCursor;

            // Define o ponto de partida das imagens
            if (foundOnPage1) {
                // Cen√°rio A: Imagens come√ßam numa p√°gina nova e limpa
                currentPage = null; 
                currentYCursor = -999; 
            } else {
                // Cen√°rio B: Imagens come√ßam NA MESMA p√°gina do quadro (Pag 2)
                currentPage = boxPage;
                currentYCursor = boxRectY - 20; // Come√ßa logo abaixo do quadro
            }

            const imgMaxWidth = width - (CONFIG.margins.left * 2);
            const imgMaxHeight = 350; 

            for (let i = 0; i < AppState.images.length; i++) {
                const imgBytes = await AppState.images[i].arrayBuffer();
                let img;
                if (AppState.images[i].type === "image/png") {
                    img = await pdfDoc.embedPng(imgBytes);
                } else {
                    img = await pdfDoc.embedJpg(imgBytes);
                }

                const scale = Math.min(imgMaxWidth / img.width, imgMaxHeight / img.height);
                const imgW = img.width * scale;
                const imgH = img.height * scale;

                if (!currentPage || (currentYCursor - imgH < CONFIG.margins.bottom)) {
                    currentPage = pdfDoc.addPage([width, height]);
                    currentYCursor = height - CONFIG.margins.top;
                }

                currentPage.drawImage(img, {
                    x: (width - imgW) / 2, 
                    y: currentYCursor - imgH,
                    width: imgW,
                    height: imgH
                });

                currentYCursor -= (imgH + 20);
            }
        }

        return await pdfDoc.save();
    }

    const triggerPreviewUpdate = debounce(async () => {
        if (!AppState.pdfBuffer) return;
        try {
            setStatus("Gerando...");
            const pdfBytes = await gerarPdfBytes();
            const blob = new Blob([pdfBytes], {type: "application/pdf"});
            document.getElementById("previewFrame").src = URL.createObjectURL(blob);
        } catch (e) { console.error(e); } 
        finally { setStatus(""); }
    }, 800);

    // Eventos
    document.querySelectorAll('.auto-update').forEach(input => input.addEventListener('input', triggerPreviewUpdate));
    document.getElementById("pdfDropZone").addEventListener('drop', (e) => { e.preventDefault(); loadPdfFile(e.dataTransfer.files[0]); });
    document.getElementById("pdfDropZone").addEventListener('dragover', (e) => e.preventDefault());
    document.getElementById("fileInput").addEventListener('change', (e) => loadPdfFile(e.target.files[0]));
    document.getElementById("imgDropZone").addEventListener('drop', (e) => { e.preventDefault(); handleImageFiles(e.dataTransfer.files); });
    document.getElementById("imgDropZone").addEventListener('dragover', (e) => e.preventDefault());
    document.getElementById("imgInput").addEventListener('change', (e) => handleImageFiles(e.target.files));
    document.getElementById("clearBtn").addEventListener("click", () => location.reload());

    document.querySelectorAll('.presetPhrase').forEach(cb => {
        cb.addEventListener('change', () => {
            const textArea = document.getElementById('ocorrencia');
            const selected = Array.from(document.querySelectorAll('.presetPhrase:checked')).map(c => c.dataset.text);
            textArea.value = selected.join('\n');
            textArea.dispatchEvent(new Event('input'));
        });
    });

    document.getElementById("downloadBtn").addEventListener("click", async () => {
        try {
            const bytes = await gerarPdfBytes();
            const blob = new Blob([bytes], { type: "application/pdf" });
            const fileName = AppState.pdfName;
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({ suggestedName: fileName, types: [{ description: 'PDF', accept: { 'application/pdf': ['.pdf'] } }]});
                    const writable = await handle.createWritable(); await writable.write(blob); await writable.close(); return;
                } catch (err) { if (err.name === 'AbortError') return; }
            }
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = fileName; link.click();
        } catch (e) { showMessage("Erro: " + e.message); }
    });

    // Mascaras
    document.getElementById('telefone').addEventListener('input', function(e){
        let v = e.target.value.replace(/\D/g,'');
        if(v.length>11) v=v.slice(0,11);
        if(v.length>10) e.target.value=`(${v.slice(0,2)}) ${v.slice(2,7)}-${v.slice(7)}`;
        else if(v.length>2) e.target.value=`(${v.slice(0,2)}) ${v.slice(2)}`;
    });
    ['nomeContato', 'endereco'].forEach(id => {
        document.getElementById(id).addEventListener('input', function() { this.value = this.value.replace(/(?:^|\s)\S/g, a => a.toUpperCase()); });
    });
});
</script>
</body>
</html>
