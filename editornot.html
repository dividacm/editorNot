// ---------- Gerar PDF ----------
async function gerarPdfFinal(){
  if(!pdfDoc || !pdfArrayBuffer) throw new Error("Carregue primeiro o PDF base.");
  const fields = [
    {label:"Telefone(s):", value: document.getElementById("telefone").value},
    {label:"Nome(s):", value: document.getElementById("nomeContato").value},
    {label:"Endereço:", value: document.getElementById("endereco").value},
    {label:"Ocorrência/Parecer:", value: document.getElementById("ocorrencia").value}
  ];
  const filledFields = fields.filter(f => f.value && f.value.trim()!=='');

  const pdfLibDoc = await PDFLib.PDFDocument.load(pdfArrayBuffer);

  const fontBold = await pdfLibDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
  const fontRegular = await pdfLibDoc.embedFont(PDFLib.StandardFonts.Helvetica);

  const pos = await findTextPosition(pdfDoc, "Gerência de Valores em Carteira e Cobrança/SEFIN-GCCOB");
  let targetPage = pdfLibDoc.getPages()[pos ? pos.page : 0];
  const { width: targetWidth, height: targetHeight } = targetPage.getSize();

  const totalLines = filledFields.map(f=>{
    const labelWidth = fontBold.widthOfTextAtSize(f.label, CONFIG.fontSize.label);
    const lines = splitTextIntoLines(f.value, fontRegular, CONFIG.fontSize.label, targetWidth-100-24-labelWidth);
    return {label:f.label, labelWidth, lines};
  });

  const rectHeight = CONFIG.maxRectHeight;
  const rectWidth = targetWidth - 100 + CONFIG.extraRectWidth;
  let rectX = CONFIG.margins.left;
  let rectY = pos ? pos.y - rectHeight - 15 : 100;

  targetPage.drawRectangle({
    x:rectX,
    y:rectY,
    width:rectWidth,
    height:rectHeight,
    borderColor:PDFLib.rgb(0,0,0),
    borderWidth:1,
    color:PDFLib.rgb(1,1,1),
    borderRadius:8
  });

  const title = "DIVISÃO DE ENTREGA DE NOTIFICAÇÕES – OFICIAIS";
  const fontSizeTitle = CONFIG.fontSize.title;
  const textWidth = fontBold.widthOfTextAtSize(title,fontSizeTitle);
  const textX = rectX + (rectWidth-textWidth)/2;
  const textY = rectY + rectHeight - fontSizeTitle - 10;
  targetPage.drawText(title,{x:textX, y:textY, size:fontSizeTitle, font:fontBold, color:PDFLib.rgb(0,0,0)});

  drawTextBlock(targetPage, rectX, textY - 15, rectHeight - fontSizeTitle - 15, totalLines, fontBold, fontRegular, CONFIG.fontSize.label);

  // Inserir imagens logo após a página do quadro
  const lastImagePageIndex = await drawImagesOnPages(pdfLibDoc, (pos ? pos.page : 0) + 1);

  // ---------- REMOVER PÁGINAS APÓS ÚLTIMA IMAGEM ----------
  if(lastImagePageIndex !== undefined){
    const pages = pdfLibDoc.getPages();
    for(let i = pages.length - 1; i >= lastImagePageIndex; i--){
      pdfLibDoc.removePage(i);
    }
  }

  return pdfLibDoc.save();
}
