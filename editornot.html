<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerar Notificação - Editor PDF</title>
<style>
:root {
  --primary-color: #0077cc;
  --primary-hover: #005fa3;
  --bg-light: #f4f4f4;
  --border-radius: 8px;
  --font-family: Arial, sans-serif;
}
body {
  font-family: var(--font-family);
  background: var(--bg-light);
  margin: 0;
  padding: 20px;
}
#container { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
.form-container {
  background: #fff; padding: 13px; border-radius: var(--border-radius); max-width: 400px; flex-shrink: 0;
}
.form-container fieldset { border: 1px solid #333; border-radius: var(--border-radius); padding: 9px 13px; margin-bottom: 15px; }
.form-container legend { font-weight: bold; padding: 0 5px; }
.form-container label { display: block; margin-top: 5px; font-weight: normal; font-size: 10pt; }
.form-container input, .form-container textarea {
  width: 100%; padding: 6px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;
  font-size: 10pt; font-weight: normal; line-height: 1em;
}
.form-container input[type="tel"] { font-family: monospace; }
.form-container button {
  padding: 8px 13px; border: none; background: var(--primary-color); color: #d3d3d3;
  border-radius: 5px; cursor: pointer; transition: background 0.2s ease; font-size: 10pt;
}
.form-container button:hover { background: var(--primary-hover); }
.preview-container { flex-grow: 1; display: flex; flex-direction: column; min-width: 300px; }
#previewFrame { flex-grow: 1; min-height: 90vh; border: 1px solid #333; margin-top: 10px; }
#messageBox { margin-top: 10px; padding: 8px; border-radius: var(--border-radius); background: #fdd; color: #900; display: none; font-size: 10pt; }
#clearBtn { padding:8px 12px; font-size:10pt; border:none; border-radius:5px; background:#d3d3d3; cursor:pointer; }
#clearBtn:hover { background:#b0b0b0; }
.button-row { display: flex; gap: 10px; align-items: center; margin-top: 10px; flex-wrap: wrap; }
</style>
</head>
<body>
<div id="container">
  <div class="form-container">
    <fieldset>
      <legend>Campos Editáveis</legend>
      <label>Telefone(s) de Contato:</label>
      <input type="tel" id="telefone" placeholder="(44) 99999-9999; (44) 98888-8888">
      <label>Nome(s) para Contato:</label>
      <input type="text" id="nomeContato" placeholder="Digite o nome">
      <label>Endereço(s):</label>
      <input type="text" id="endereco" placeholder="Rua, número, bairro">
      <label>Ocorrências/Parecer:</label>
      <textarea id="ocorrencia" rows="5" placeholder="Descreva a ocorrência..."></textarea>

      <fieldset>
        <legend>Frases Predefinidas</legend>
        <div>
          <label>
            <input type="checkbox" class="presetPhrase" data-text="Contato realizado via WhatsApp com onde foi enviada a notificação. Comprovante em anexo.">
            Contato realizado via WhatsApp com notificação enviada
          </label>
        </div>
        <div>
          <label>
            <input type="checkbox" class="presetPhrase" data-text="Cadastro incompleto ou sem telefone em funcionamento. Realizada três tentativa de entrega nos dias , notificação deixada. Comprovante em anexo.">
            Cadastro incompleto, tentativas de entrega
          </label>
        </div>
        <div>
          <label>
            <input type="checkbox" class="presetPhrase" data-text="Realizada tentativa de contato via WhatsApp sem retorno, não encontrado contribuinte no endereço indicado, sem endereço de correspondência, impossibilitando entrega da notificação. Comprovante em anexo">
            Realizada tentativa de contato via WhatsApp sem retorno
          </label>
        </div>
      </fieldset>
    </fieldset>

    <fieldset>
      <legend>Upload de Imagens</legend>
      <div id="imgUploadsContainer"></div>
      <button id="addImageBtn" type="button">Adicionar Imagem</button>
    </fieldset>

    <fieldset>
      <legend>PDF Base</legend>
      <div class="toolbar">
        <input type="file" id="fileInput" accept="application/pdf">
      </div>
      <div id="messageBox"></div>
    </fieldset>
  </div>

  <div class="preview-container">
    <div class="button-row">
      <button id="previewBtn">Pré-visualizar PDF</button>
      <button id="downloadBtn">Baixar PDF Final</button>
      <button id="clearBtn">Limpar</button>
    </div>
    <iframe id="previewFrame" title="Pré-visualização do PDF"></iframe>
  </div>
</div>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
let pdfDoc = null;
let originalFileName = "arquivo.pdf";
const CONFIG = {
  margins: { left: 39, right: 41, top: 140, bottom: 49 },
  fontSize: { title: 12, label: 11, minLabel: 7 },
  spacing: { label: 12 },
  maxRectHeight: 198.45, 
  extraRectWidth: 22.68, 
  headerGap: 12.17
};

// ---------- Funções auxiliares ----------
function showMessage(msg) {
  const messageBox = document.getElementById("messageBox");
  messageBox.textContent = msg;
  messageBox.style.display = "block";
  setTimeout(() => messageBox.style.display = "none", 4000);
}
function splitTextIntoLines(text, font, fontSize, maxWidth) {
  if (!text) return [];
  text = text.replace(/\n/g,' ');
  const words = text.split(' ');
  const lines = [];
  let currentLine = '';
  for (const w of words) {
    const testLine = currentLine ? currentLine + ' ' + w : w;
    const width = font.widthOfTextAtSize(testLine, fontSize);
    if (width > maxWidth) {
      if (currentLine) lines.push(currentLine);
      currentLine = w;
    } else currentLine = testLine;
  }
  if (currentLine) lines.push(currentLine);
  return lines;
}
function drawTextBlock(page, x, yTop, rectHeight, totalLines, fontBold, fontRegular, fontSizeLabel) {
  if(totalLines.length === 0) return;
  let fontSize = fontSizeLabel;
  while(fontSize >= CONFIG.fontSize.minLabel){
    let totalHeight = totalLines.reduce((acc,item)=> acc + item.lines.length*CONFIG.spacing.label + CONFIG.spacing.label/2, 0) + CONFIG.headerGap;
    if(totalHeight <= rectHeight) break;
    fontSize -= 0.5;
  }
  let y = yTop - CONFIG.headerGap;
  totalLines.forEach(item => {
    page.drawText(item.label, {x: x+12, y: y, size: fontSize, font: fontBold});
    item.lines.forEach(line=>{
      page.drawText(line, {x: x+12+item.labelWidth+5, y: y, size: fontSize, font: fontRegular});
      y -= CONFIG.spacing.label;
    });
    y -= CONFIG.spacing.label/2;
  });
}

// ---------- Máscara telefone ----------
const telefoneInput = document.getElementById("telefone");
telefoneInput.addEventListener("input", (e)=>{
  let values = e.target.value.split(';').map(v=>v.replace(/\D/g,'').slice(0,11)); 
  let formattedValues = values.map(v=>{
    let formatted = '';
    if(v.length > 0) formatted += '(' + v.slice(0,2);
    if(v.length >= 3) formatted += ') ' + v.slice(2,7);
    if(v.length >= 8) formatted += '-' + v.slice(7);
    return formatted;
  });
  e.target.value = formattedValues.join('; ');
});

// ---------- Localizar texto ----------
async function findTextPosition(pdf, searchText) {
  for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
    const page = await pdf.getPage(pageNum);
    const textContent = await page.getTextContent();
    for (let item of textContent.items) {
      if (item.str && item.str.toLowerCase().includes(searchText.toLowerCase())) {
        const tx = item.transform[4];
        const ty = item.transform[5];
        const fontHeight = item.transform[3];
        return { page: pageNum - 1, x: tx, y: ty, height: fontHeight };
      }
    }
  }
  return null;
}

// ---------- Upload PDF ----------
document.getElementById("fileInput").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;
  originalFileName = file.name;
  const arrayBuffer = await file.arrayBuffer();
  pdfDoc = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
});

// ---------- Adicionar imagens (corrigido) ----------
document.getElementById("addImageBtn").addEventListener("click", () => {
  const container = document.getElementById("imgUploadsContainer");
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.className = "imgUpload";
  input.style.display = "none";
  container.appendChild(input);

  const row = document.createElement("div");
  row.className = "imgRow";
  row.style.display = "flex";
  row.style.alignItems = "center";
  row.style.gap = "8px";
  row.style.marginTop = "8px";

  const thumb = document.createElement("div");
  thumb.style.width = "72px";
  thumb.style.height = "60px";
  thumb.style.overflow = "hidden";
  thumb.style.display = "flex";
  thumb.style.alignItems = "center";
  thumb.style.justifyContent = "center";

  const nameSpan = document.createElement("span");
  nameSpan.textContent = "Nenhum arquivo selecionado";
  nameSpan.style.flex = "1";
  nameSpan.style.fontSize = "0.95rem";
  nameSpan.style.wordBreak = "break-word";

  const chooseBtn = document.createElement("button");
  chooseBtn.type = "button";
  chooseBtn.textContent = "Escolher";

  const removeBtn = document.createElement("button");
  removeBtn.type = "button";
  removeBtn.textContent = "Remover";

  row.appendChild(thumb);
  row.appendChild(nameSpan);
  row.appendChild(chooseBtn);
  row.appendChild(removeBtn);
  container.appendChild(row);

  chooseBtn.addEventListener("click", ()=>input.click());
  removeBtn.addEventListener("click", ()=>{ input.remove(); row.remove(); });
  input.addEventListener("change", ()=>{
    if(!input.files.length){ nameSpan.textContent="Nenhum arquivo selecionado"; thumb.innerHTML=""; return;}
    const file = input.files[0];
    nameSpan.textContent = file.name;
    const reader = new FileReader();
    reader.onload = (e)=>{
      thumb.innerHTML="";
      const img = document.createElement("img");
      img.src = e.target.result;
      img.style.maxWidth="100%";
      img.style.maxHeight="100%";
      img.style.objectFit="cover";
      thumb.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
  input.click();
});

// ---------- Desenhar imagens (uma embaixo da outra) ----------
async function drawImagesOnPages(pdfLibDoc, targetPageIndex) {
  const uploads = Array.from(document.querySelectorAll(".imgUpload")).filter(i => i.files.length);
  if (!uploads.length) return;
  const pages = pdfLibDoc.getPages();
  const pageWidth = pages[0].getWidth();
  const pageHeight = pages[0].getHeight();
  const usableWidth = pageWidth - CONFIG.margins.left - CONFIG.margins.right;
  const usableHeight = pageHeight - CONFIG.margins.top - CONFIG.margins.bottom;
  let currentPageIndex = targetPageIndex + 1;
  let currentPage = pages[currentPageIndex] || pdfLibDoc.addPage([pageWidth, pageHeight]);
  let cursorY = pageHeight - CONFIG.margins.top;

  for (const upload of uploads) {
    const file = upload.files[0];
    const bytes = await file.arrayBuffer();
    const img = file.type === "image/png" ? await pdfLibDoc.embedPng(bytes) : await pdfLibDoc.embedJpg(bytes);
    const dims = img.scale(1);

    const scale = Math.min(usableWidth / dims.width, 1);
    let imgWidth = dims.width * scale;
    let imgHeight = dims.height * scale;
    if (imgHeight > usableHeight) {
      const fitScale = usableHeight / imgHeight;
      imgWidth *= fitScale;
      imgHeight *= fitScale;
    }
    if (cursorY - imgHeight < CONFIG.margins.bottom) {
      currentPageIndex++;
      currentPage = pages[currentPageIndex] || pdfLibDoc.addPage([pageWidth, pageHeight]);
      cursorY = pageHeight - CONFIG.margins.top;
    }

    currentPage.drawRectangle({
      x: CONFIG.margins.left,
      y: cursorY - imgHeight,
      width: usableWidth,
      height: imgHeight,
      color: PDFLib.rgb(1, 1, 1)
    });

    const x = (pageWidth - imgWidth) / 2;
    const y = cursorY - imgHeight;
    currentPage.drawImage(img, { x, y, width: imgWidth, height: imgHeight });
    cursorY = y - 10;
  }

  const totalPages = pdfLibDoc.getPages().length;
  for (let i = totalPages - 1; i > currentPageIndex; i--) pdfLibDoc.removePage(i);
}

// ---------- Gerar PDF final ----------
async function gerarPdfFinal(){
  if(!pdfDoc) throw new Error("Carregue primeiro o PDF base.");
  const fields = [
    {label:"Telefone(s):", value: document.getElementById("telefone").value},
    {label:"Nome(s):", value: document.getElementById("nomeContato").value},
    {label:"Endereço:", value: document.getElementById("endereco").value},
    {label:"Ocorrência/Parecer:", value: document.getElementById("ocorrencia").value}
  ];
  const filled = fields.filter(f => f.value.trim()!=='');
  const pdfBytes = await pdfDoc.getData();
  const pdfLibDoc = await PDFLib.PDFDocument.load(pdfBytes);
  const fontBold = await pdfLibDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
  const fontRegular = await pdfLibDoc.embedFont(PDFLib.StandardFonts.Helvetica);
  const pos = await findTextPosition(pdfDoc, "Gerência de Valores em Carteira e Cobrança/SEFIN-GCCOB");
  let targetPage = pdfLibDoc.getPages()[pos ? pos.page : 0];
  const { width, height } = targetPage.getSize();
  const totalLines = filled.map(f=>{
    const labelWidth = fontBold.widthOfTextAtSize(f.label, CONFIG.fontSize.label);
    const lines = splitTextIntoLines(f.value, fontRegular, CONFIG.fontSize.label, width-100-24-labelWidth);
    return {label:f.label, labelWidth, lines};
  });
  const rectHeight = CONFIG.maxRectHeight;
  const rectWidth = width - 100 + CONFIG.extraRectWidth;
  let rectX = CONFIG.margins.left;
  let rectY = pos ? pos.y - rectHeight - 15 : 100;

  targetPage.drawRectangle({x:rectX,y:rectY,width:rectWidth,height:rectHeight,borderColor:PDFLib.rgb(0,0,0),borderWidth:1,color:PDFLib.rgb(1,1,1)});
  const title = "DIVISÃO DE ENTREGA DE NOTIFICAÇÕES – OFICIAIS";
  const textWidth = fontBold.widthOfTextAtSize(title,CONFIG.fontSize.title);
  const textX = rectX + (rectWidth-textWidth)/2;
  const textY = rectY + rectHeight - CONFIG.fontSize.title - 10;
  targetPage.drawText(title,{x:textX,y:textY,size:CONFIG.fontSize.title,font:fontBold});
  drawTextBlock(targetPage, rectX, textY - 15, rectHeight - CONFIG.fontSize.title - 15, totalLines, fontBold, fontRegular, CONFIG.fontSize.label);
  await drawImagesOnPages(pdfLibDoc, pos ? pos.page : 0);
  return pdfLibDoc.save();
}

// ---------- Botões ----------
document.getElementById("previewBtn").addEventListener("click", async ()=>{
  try{
    const newPdfBytes = await gerarPdfFinal();
    const blob = new Blob([newPdfBytes], {type:"application/pdf"});
    const url = URL.createObjectURL(blob);
    document.getElementById("previewFrame").src = url;
  }catch(err){ showMessage("Erro: "+err.message); }
});
document.getElementById("downloadBtn").addEventListener("click", async ()=>{
  try{
    const newPdfBytes = await gerarPdfFinal();
    const blob = new Blob([newPdfBytes], {type:"application/pdf"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "EDITADO_" + originalFileName;
    a.click();
  }catch(err){ showMessage("Erro: "+err.message); }
});
document.getElementById("clearBtn").addEventListener("click", ()=>{
  document.getElementById("telefone").value = "";
  document.getElementById("nomeContato").value = "";
  document.getElementById("endereco").value = "";
  document.getElementById("ocorrencia").value = "";
  document.getElementById("imgUploadsContainer").innerHTML = "";
  document.getElementById("previewFrame").src = "";
  showMessage("Formulário limpo com sucesso!");
});
</script>
</body>
</html>
