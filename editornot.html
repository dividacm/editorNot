<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerar Notificação - Editor PDF</title>
<style>
:root {
  --primary-color: #0077cc;
  --primary-hover: #005fa3;
  --bg-light: #f4f4f4;
  --border-radius: 8px;
  --font-family: Arial, sans-serif;
}
body {
  font-family: var(--font-family);
  background: var(--bg-light);
  margin: 0;
  padding: 20px;
}
#container { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
.form-container {
  background: #fff; padding: 13px; border-radius: var(--border-radius); max-width: 400px; flex-shrink: 0;
}
.form-container fieldset { border: 1px solid #333; border-radius: var(--border-radius); padding: 9px 13px; margin-bottom: 15px; }
.form-container legend { font-weight: bold; padding: 0 5px; }
.form-container label { display: block; margin-top: 5px; font-weight: normal; font-size: 10pt; }
.form-container input, .form-container textarea {
  width: 100%; padding: 6px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;
  font-size: 10pt; font-weight: normal; line-height: 1em;
}
.form-container input[type="tel"] { font-family: monospace; }
.form-container button {
  padding: 8px 13px; border: none; background: var(--primary-color); color: #d3d3d3;
  border-radius: 5px; cursor: pointer; transition: background 0.2s ease; font-size: 10pt;
}
.form-container button:hover { background: var(--primary-hover); }
.preview-container { flex-grow: 1; display: flex; flex-direction: column; min-width: 300px; }
#previewFrame { flex-grow: 1; min-height: 90vh; border: 1px solid #333; margin-top: 10px; }
#messageBox { margin-top: 10px; padding: 8px; border-radius: var(--border-radius); background: #fdd; color: #900; display: none; font-size: 10pt; }
#clearBtn { padding:8px 12px; font-size:10pt; border:none; border-radius:5px; background:#d3d3d3; cursor:pointer; }
#clearBtn:hover { background:#b0b0b0; }
.button-row { display: flex; gap: 10px; align-items: center; margin-top: 10px; flex-wrap: wrap; }
</style>
</head>
<body>
<div id="container">
  <div class="form-container">
    <fieldset>
      <legend>Campos Editáveis</legend>
      <label>Telefone(s) de Contato:</label>
      <input type="tel" id="telefone" placeholder="(44) 99999-9999; (44) 98888-8888">
      <label>Nome(s) para Contato:</label>
      <input type="text" id="nomeContato" placeholder="Digite o nome">
      <label>Endereço(s):</label>
      <input type="text" id="endereco" placeholder="Rua, número, bairro">
      <label>Ocorrências/Parecer:</label>
      <textarea id="ocorrencia" rows="5" placeholder="Descreva a ocorrência..."></textarea>
    </fieldset>

    <fieldset>
      <legend>Upload de Imagens</legend>
      <div id="imgUploadsContainer"></div>
      <button id="addImageBtn" type="button">Adicionar Imagem</button>
    </fieldset>

    <fieldset>
      <legend>PDF Base</legend>
      <div class="toolbar">
        <input type="file" id="fileInput" accept="application/pdf">
      </div>
      <div id="messageBox"></div>
    </fieldset>
  </div>

  <div class="preview-container">
    <div class="button-row">
      <button id="previewBtn">Pré-visualizar PDF</button>
      <button id="downloadBtn">Baixar PDF Final</button>
      <button id="clearBtn">Limpar</button>
    </div>
    <iframe id="previewFrame" title="Pré-visualização do PDF"></iframe>
  </div>
</div>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
let pdfDoc = null;
let originalFileName = "arquivo.pdf";

function showMessage(msg) {
  const messageBox = document.getElementById("messageBox");
  messageBox.textContent = msg;
  messageBox.style.display = "block";
  setTimeout(() => messageBox.style.display = "none", 4000);
}

// Upload PDF
document.getElementById("fileInput").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;
  originalFileName = file.name;
  const arrayBuffer = await file.arrayBuffer();
  pdfDoc = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
});

// Upload Imagens
document.getElementById("addImageBtn").addEventListener("click", () => {
  const container = document.getElementById("imgUploadsContainer");
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.className = "imgUpload";
  input.style.display = "none";
  container.appendChild(input);

  const row = document.createElement("div");
  row.style.display = "flex";
  row.style.alignItems = "center";
  row.style.gap = "8px";
  row.style.marginTop = "8px";

  const thumb = document.createElement("div");
  thumb.style.width = "72px";
  thumb.style.height = "60px";
  thumb.style.overflow = "hidden";
  thumb.style.display = "flex";
  thumb.style.alignItems = "center";
  thumb.style.justifyContent = "center";

  const nameSpan = document.createElement("span");
  nameSpan.textContent = "Nenhum arquivo selecionado";
  nameSpan.style.flex = "1";
  nameSpan.style.fontSize = "0.95rem";
  nameSpan.style.wordBreak = "break-word";

  const chooseBtn = document.createElement("button");
  chooseBtn.type = "button";
  chooseBtn.textContent = "Escolher";

  const removeBtn = document.createElement("button");
  removeBtn.type = "button";
  removeBtn.textContent = "Remover";

  row.appendChild(thumb);
  row.appendChild(nameSpan);
  row.appendChild(chooseBtn);
  row.appendChild(removeBtn);
  container.appendChild(row);

  chooseBtn.addEventListener("click", ()=>input.click());
  removeBtn.addEventListener("click", ()=>{ input.remove(); row.remove(); });
  input.addEventListener("change", ()=>{
    if(!input.files.length){ nameSpan.textContent="Nenhum arquivo selecionado"; thumb.innerHTML=""; return;}
    const file = input.files[0];
    nameSpan.textContent = file.name;
    const reader = new FileReader();
    reader.onload = (e)=>{
      thumb.innerHTML="";
      const img = document.createElement("img");
      img.src = e.target.result;
      img.style.maxWidth="100%";
      img.style.maxHeight="100%";
      img.style.objectFit="cover";
      thumb.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
  input.click();
});

// === Redimensionar para DUAS por página ===
async function drawImagesTwoPerPage(pdfLibDoc) {
  const uploads = Array.from(document.querySelectorAll(".imgUpload")).filter(i => i.files.length);
  if (!uploads.length) return;

  const pages = pdfLibDoc.getPages();
  const firstPage = pages[0];
  const pageWidth = firstPage.getWidth();
  const pageHeight = firstPage.getHeight();

  const usableWidth = pageWidth - 80;
  const maxImagesPerPage = 2;
  const imagesPerPageHeight = pageHeight - 160; // margem superior/inferior

  let currentPage = pdfLibDoc.addPage([pageWidth, pageHeight]);
  let cursorY = pageHeight - 80;
  let imageCount = 0;

  for (const upload of uploads) {
    const file = upload.files[0];
    const bytes = await file.arrayBuffer();
    const img = file.type === "image/png" ? await pdfLibDoc.embedPng(bytes) : await pdfLibDoc.embedJpg(bytes);
    const dims = img.scale(1);

    const scale = Math.min(usableWidth / dims.width, 1);
    let imgWidth = dims.width * scale;
    let imgHeight = dims.height * scale;

    // Se for mais alto do que metade da página útil, ajusta
    const maxHeightPerImage = imagesPerPageHeight / maxImagesPerPage;
    if (imgHeight > maxHeightPerImage) {
      const fitScale = maxHeightPerImage / imgHeight;
      imgWidth *= fitScale;
      imgHeight *= fitScale;
    }

    const x = (pageWidth - imgWidth) / 2;
    const y = cursorY - imgHeight;

    currentPage.drawRectangle({ x, y, width: imgWidth, height: imgHeight, color: PDFLib.rgb(1,1,1) });
    currentPage.drawImage(img, { x, y, width: imgWidth, height: imgHeight });

    cursorY = y - 40;
    imageCount++;

    if (imageCount % 2 === 0 && upload !== uploads[uploads.length - 1]) {
      currentPage = pdfLibDoc.addPage([pageWidth, pageHeight]);
      cursorY = pageHeight - 80;
    }
  }
}

async function gerarPdfFinal(){
  if(!pdfDoc) throw new Error("Carregue primeiro o PDF base.");
  const pdfBytes = await pdfDoc.getData();
  const pdfLibDoc = await PDFLib.PDFDocument.load(pdfBytes);
  await drawImagesTwoPerPage(pdfLibDoc);
  return pdfLibDoc.save();
}

// Botões
document.getElementById("previewBtn").addEventListener("click", async ()=>{
  try{
    const newPdfBytes = await gerarPdfFinal();
    const blob = new Blob([newPdfBytes], {type:"application/pdf"});
    const url = URL.createObjectURL(blob);
    document.getElementById("previewFrame").src = url;
  }catch(err){ showMessage("Erro: "+err.message); }
});

document.getElementById("downloadBtn").addEventListener("click", async ()=>{
  try{
    const newPdfBytes = await gerarPdfFinal();
    const handle = await window.showSaveFilePicker({
      suggestedName: originalFileName,
      types: [{ description: 'PDF Files', accept: { 'application/pdf': ['.pdf'] } }]
    });
    const writable = await handle.createWritable();
    await writable.write(newPdfBytes);
    await writable.close();
    showMessage("PDF salvo com sucesso!");
  }catch(err){ showMessage("Erro: "+err.message); }
});

document.getElementById("clearBtn").addEventListener("click", ()=>{
  document.getElementById("telefone").value = "";
  document.getElementById("nomeContato").value = "";
  document.getElementById("endereco").value = "";
  document.getElementById("ocorrencia").value = "";
  document.getElementById("imgUploadsContainer").innerHTML = "";
  document.getElementById("previewFrame").src = "";
  showMessage("Formulário limpo com sucesso!");
});
</script>
</body>
</html>
