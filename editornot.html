<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerar Notifica√ß√£o - Editor PDF</title>
<style>
:root {
  --primary-color: #0077cc;
  --primary-hover: #005fa3;
  --bg-light: #f4f4f4;
  --border-radius: 8px;
  --font-family: Arial, sans-serif;
}
body {
  font-family: var(--font-family);
  background: var(--bg-light);
  margin: 0;
  padding: 20px;
}
#container { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
.form-container {
  background: #fff; padding: 13px; border-radius: var(--border-radius); max-width: 400px; flex-shrink: 0;
}
.form-container fieldset { border: 1px solid #333; border-radius: var(--border-radius); padding: 9px 13px; margin-bottom: 15px; }
.form-container legend { font-weight: bold; padding: 0 5px; }
.form-container label { display: block; margin-top: 5px; font-weight: normal; font-size: 10pt; }
.form-container input, .form-container textarea {
  width: 100%; padding: 6px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;
  font-size: 10pt; font-weight: normal; line-height: 1em;
}
.form-container input[type="tel"] { font-family: monospace; }
.form-container button {
  padding: 8px 13px; border: none; background: var(--primary-color); color: #d3d3d3;
  border-radius: 5px; cursor: pointer; transition: background 0.2s ease; font-size: 10pt;
}
.form-container button:hover { background: var(--primary-hover); }
.preview-container { flex-grow: 1; display: flex; flex-direction: column; min-width: 300px; }
#previewFrame { flex-grow: 1; min-height: 90vh; border: 1px solid #333; margin-top: 10px; }
#messageBox { margin-top: 10px; padding: 8px; border-radius: var(--border-radius); background: #fdd; color: #900; display: none; font-size: 10pt; }
#clearBtn { padding:8px 12px; font-size:10pt; border:none; border-radius:5px; background:#d3d3d3; cursor:pointer; }
#clearBtn:hover { background:#b0b0b0; }
.button-row { display: flex; gap: 10px; align-items: center; margin-top: 10px; flex-wrap: wrap; }
</style>
</head>
<body>
<div id="container">
  <div class="form-container">
    <fieldset>
      <legend>Campos Edit√°veis</legend>
      <label>Telefone(s) de Contato:</label>
      <input type="tel" id="telefone" placeholder="(44) 99999-9999; (44) 98888-8888">
      <label>Nome(s) para Contato:</label>
      <input type="text" id="nomeContato" placeholder="Digite o nome">
      <label>Endere√ßo(s):</label>
      <input type="text" id="endereco" placeholder="Rua, n√∫mero, bairro">
      <label>Ocorr√™ncias/Parecer:</label>
      <textarea id="ocorrencia" rows="5" placeholder="Descreva a ocorr√™ncia..."></textarea>

      <fieldset>
        <legend>Frases Predefinidas</legend>
        <div>
          <label>
            <input type="checkbox" class="presetPhrase" data-text="Contato realizado via WhatsApp com onde foi enviada a notifica√ß√£o. Comprovante em anexo.">
            Contato realizado via WhatsApp com notifica√ß√£o enviada
          </label>
        </div>
        <div>
          <label>
            <input type="checkbox" class="presetPhrase" data-text="Cadastro incompleto ou sem telefone em funcionamento. Realizada tr√™s tentativa de entrega nos dias , notifica√ß√£o deixada. Comprovante em anexo.">
            Cadastro incompleto, tentativas de entrega
          </label>
        </div>
        <div>
          <label>
            <input type="checkbox" class="presetPhrase" data-text="Realizada tentativa de contato via WhatsApp sem retorno, n√£o encontrado contribuinte no endere√ßo indicado, sem endere√ßo de correspond√™ncia, impossibilitando entrega da notifica√ß√£o. Comprovante em anexo">
            Realizada tentativa de contato via WhatsApp sem retorno
          </label>
        </div>
      </fieldset>
    </fieldset>

    <fieldset>
      <legend>Upload de Imagens</legend>
      <div id="imgUploadsContainer"></div>
      <button id="addImageBtn" type="button">Adicionar Imagem</button>
    </fieldset>

    <fieldset>
      <legend>PDF Base</legend>
      <div class="toolbar">
        <input type="file" id="fileInput" accept="application/pdf">
      </div>
      <div id="messageBox"></div>
    </fieldset>
  </div>

  <div class="preview-container">
    <div class="button-row">
      <button id="previewBtn">Pr√©-visualizar PDF</button>
      <button id="downloadBtn">Baixar PDF Final</button>
      <button id="clearBtn">Limpar</button>
    </div>
    <iframe id="previewFrame" title="Pr√©-visualiza√ß√£o do PDF"></iframe>
  </div>
</div>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
let pdfDoc = null;
let originalFileName = "arquivo.pdf";
const CONFIG = {
  margins: { left: 40, right: 40, top: 140, bottom: 49 },
  fontSize: { title: 12, label: 11, minLabel: 7 },
  spacing: { label: 12 },
  maxRectHeight: 198.45, 
  extraRectWidth: 22.68, 
  headerGap: 12.17
};

// ---------- Fun√ß√µes auxiliares ----------
function showMessage(msg) {
  const messageBox = document.getElementById("messageBox");
  messageBox.textContent = msg;
  messageBox.style.display = "block";
  setTimeout(() => messageBox.style.display = "none", 4000);
}
function splitTextIntoLines(text, font, fontSize, maxWidth) {
  if (!text) return [];
  text = text.replace(/\n/g,' ');
  const words = text.split(' ');
  const lines = [];
  let currentLine = '';
  for (const w of words) {
    const testLine = currentLine ? currentLine + ' ' + w : w;
    const width = font.widthOfTextAtSize(testLine, fontSize);
    if (width > maxWidth) {
      if (currentLine) lines.push(currentLine);
      currentLine = w;
    } else currentLine = testLine;
  }
  if (currentLine) lines.push(currentLine);
  return lines;
}
function drawTextBlock(page, x, yTop, rectHeight, totalLines, fontBold, fontRegular, fontSizeLabel) {
  if(totalLines.length === 0) return;
  let fontSize = fontSizeLabel;
  while(fontSize >= CONFIG.fontSize.minLabel){
    let totalHeight = totalLines.reduce((acc,item)=> acc + item.lines.length*CONFIG.spacing.label + CONFIG.spacing.label/2, 0) + CONFIG.headerGap;
    if(totalHeight <= rectHeight) break;
    fontSize -= 0.5;
  }
  let y = yTop - CONFIG.headerGap;
  totalLines.forEach(item => {
    page.drawText(item.label, {x: x+12, y: y, size: fontSize, font: fontBold});
    item.lines.forEach(line=>{
      page.drawText(line, {x: x+12+item.labelWidth+5, y: y, size: fontSize, font: fontRegular});
      y -= CONFIG.spacing.label;
    });
    y -= CONFIG.spacing.label/2;
  });
}

// ---------- Fun√ß√£o para localizar frase ----------
async function findTextPosition(pdf, searchText) {
  for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
    const page = await pdf.getPage(pageNum);
    const textContent = await page.getTextContent();
    for (let item of textContent.items) {
      if (item.str && item.str.toLowerCase().includes(searchText.toLowerCase())) {
        const tx = item.transform[4];
        const ty = item.transform[5];
        const fontHeight = item.transform[3];
        return { page: pageNum - 1, x: tx, y: ty, height: fontHeight };
      }
    }
  }
  return null;
}

// ---------- Upload PDF base ----------
document.getElementById("fileInput").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;
  originalFileName = file.name;
  const arrayBuffer = await file.arrayBuffer();
  pdfDoc = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
});

// ---------- Adicionar imagens ----------
document.getElementById("addImageBtn").addEventListener("click", () => {
  const container = document.getElementById("imgUploadsContainer");
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.className = "imgUpload";
  container.appendChild(input);
});

// ---------- Desenhar imagens (mant√©m p√°ginas originais) ----------
async function drawImagesOnPages(pdfLibDoc, targetPageIndex) {
  const uploads = Array.from(document.querySelectorAll(".imgUpload")).filter(input => input.files.length);
  if (!uploads.length) return;

  const pages = pdfLibDoc.getPages();
  const pageWidth = pages[0].getWidth();
  const pageHeight = pages[0].getHeight();

  const maxWidth = pageWidth - CONFIG.margins.left - CONFIG.margins.right;
  const maxHeight = pageHeight - CONFIG.margins.top - CONFIG.margins.bottom;

  let currentPageIndex = targetPageIndex + 1;
  let currentPage = pages[currentPageIndex] || pdfLibDoc.addPage([pageWidth, pageHeight]);

  let placedImages = 0;

  for (let i = 0; i < uploads.length; i++) {
    const file = uploads[i].files[0];
    const bytes = await file.arrayBuffer();
    const img = file.type === 'image/png' ? await pdfLibDoc.embedPng(bytes) : await pdfLibDoc.embedJpg(bytes);
    const dims = img.scale(1);

    // √Årea para caber 2 imagens na p√°gina
    const halfHeight = maxHeight / 2 - 10;
    let scale = Math.min(maxWidth / dims.width, halfHeight / dims.height);

    // Se n√£o couber duas, usa a p√°gina inteira
    if (scale <= 0) {
      scale = Math.min(maxWidth / dims.width, maxHeight / dims.height);
    }

    const imgWidth = dims.width * scale;
    const imgHeight = dims.height * scale;
    const x = (pageWidth - imgWidth) / 2;

    if (placedImages === 0) {
      // üî≤ fundo branco na metade superior
      currentPage.drawRectangle({
        x: CONFIG.margins.left,
        y: pageHeight - CONFIG.margins.top - maxHeight,
        width: maxWidth,
        height: maxHeight,
        color: PDFLib.rgb(1, 1, 1),
        opacity: 1
      });

      // primeira imagem
      currentPage.drawImage(img, {
        x,
        y: pageHeight - CONFIG.margins.top - imgHeight,
        width: imgWidth,
        height: imgHeight
      });

      placedImages = 1;
    } else {
      // üî≤ fundo branco na metade inferior
      currentPage.drawRectangle({
        x: CONFIG.margins.left,
        y: CONFIG.margins.bottom,
        width: maxWidth,
        height: halfHeight,
        color: PDFLib.rgb(1, 1, 1),
        opacity: 1
      });

      // segunda imagem
      currentPage.drawImage(img, {
        x,
        y: CONFIG.margins.bottom,
        width: imgWidth,
        height: imgHeight
      });

      placedImages = 0;

      // Se ainda h√° mais imagens ‚Üí nova p√°gina
      if (i < uploads.length - 1) {
        currentPageIndex++;
        currentPage = pages[currentPageIndex] || pdfLibDoc.addPage([pageWidth, pageHeight]);
      }
    }
  }

  // remove p√°ginas extras depois da √∫ltima usada
  const totalPages = pdfLibDoc.getPages().length;
  for (let i = totalPages - 1; i > currentPageIndex; i--) {
    pdfLibDoc.removePage(i);
  }
}


// ---------- Gerar PDF final ----------
async function gerarPdfFinal(){
  if(!pdfDoc) throw new Error("Carregue primeiro o PDF base.");
  const fields = [
    {label:"Telefone(s):", value: document.getElementById("telefone").value},
    {label:"Nome(s):", value: document.getElementById("nomeContato").value},
    {label:"Endere√ßo:", value: document.getElementById("endereco").value},
    {label:"Ocorr√™ncia/Parecer:", value: document.getElementById("ocorrencia").value}
  ];
  const filledFields = fields.filter(f => f.value && f.value.trim()!=='');

  const pdfBytes = await pdfDoc.getData();
  const pdfLibDoc = await PDFLib.PDFDocument.load(pdfBytes);

  const fontBold = await pdfLibDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
  const fontRegular = await pdfLibDoc.embedFont(PDFLib.StandardFonts.Helvetica);

  // Buscar posi√ß√£o da frase alvo
  const pos = await findTextPosition(pdfDoc, "Ger√™ncia de Valores em Carteira e Cobran√ßa/SEFIN-GCCOB");
  let targetPage = pdfLibDoc.getPages()[pos ? pos.page : 0];
  const { width, height } = targetPage.getSize();

  const totalLines = filledFields.map(f=>{
    const labelWidth = fontBold.widthOfTextAtSize(f.label, CONFIG.fontSize.label);
    const lines = splitTextIntoLines(f.value, fontRegular, CONFIG.fontSize.label, width-100-24-labelWidth);
    return {label:f.label, labelWidth, lines};
  });

  const rectHeight = CONFIG.maxRectHeight;
  const rectWidth = width - 100 + CONFIG.extraRectWidth;
  let rectX, rectY;
  if (pos) {
    rectX = CONFIG.margins.left;
    rectY = pos.y - rectHeight - 15;
  } else {
    rectX = 50;
    rectY = 100;
  }

  targetPage.drawRectangle({
    x:rectX, 
    y:rectY, 
    width:rectWidth, 
    height:rectHeight, 
    borderColor:PDFLib.rgb(0,0,0), 
    borderWidth:1, 
    color:PDFLib.rgb(1,1,1), 
    borderRadius:8
  });

  const title = "DIVIS√ÉO DE ENTREGA DE NOTIFICA√á√ïES ‚Äì OFICIAIS";
  const fontSizeTitle = CONFIG.fontSize.title;
  const textWidth = fontBold.widthOfTextAtSize(title,fontSizeTitle);
  const textX = rectX + (rectWidth-textWidth)/2;
  const textY = rectY + rectHeight - fontSizeTitle - 10;
  targetPage.drawText(title,{x:textX, y:textY, size:fontSizeTitle, font:fontBold, color:PDFLib.rgb(0,0,0)});

  drawTextBlock(targetPage, rectX, textY - 15, rectHeight - fontSizeTitle - 15, totalLines, fontBold, fontRegular, CONFIG.fontSize.label);

  await drawImagesOnPages(pdfLibDoc, pos ? pos.page : 0);
  return pdfLibDoc.save();
}

// ---------- Bot√µes ----------
document.getElementById("previewBtn").addEventListener("click", async ()=>{
  try{
    const newPdfBytes = await gerarPdfFinal();
    const blob = new Blob([newPdfBytes], {type:"application/pdf"});
    const url = URL.createObjectURL(blob);
    const frame = document.getElementById("previewFrame");
    frame.src = url;
    frame.onload = ()=>URL.revokeObjectURL(url);
  }catch(err){ showMessage("Erro: "+err.message); }
});

document.getElementById("downloadBtn").addEventListener("click", async ()=>{
  try{
    const newPdfBytes = await gerarPdfFinal();
    const handle = await window.showSaveFilePicker({
      suggestedName: originalFileName,
      types: [{ description: 'PDF Files', accept: { 'application/pdf': ['.pdf'] } }]
    });
    const writable = await handle.createWritable();
    await writable.write(newPdfBytes);
    await writable.close();
    showMessage("PDF salvo com sucesso!");
  }catch(err){ showMessage("Erro: "+err.message); }
});

document.getElementById("clearBtn").addEventListener("click", ()=>{
  ["telefone","nomeContato","endereco","ocorrencia"].forEach(id => document.getElementById(id).value='');
  document.querySelectorAll(".presetPhrase").forEach(cb => cb.checked=false);
  document.querySelectorAll(".imgUpload").forEach(i=>i.remove());
  document.getElementById("fileInput").value='';
  pdfDoc = null;
  document.getElementById("previewFrame").src = '';
});

// ---------- Frases predefinidas ----------
const checkboxes = document.querySelectorAll(".presetPhrase");
const ocorrenciaField = document.getElementById("ocorrencia");
checkboxes.forEach(cb=>{
  cb.addEventListener("change", ()=>{
    const lines = ocorrenciaField.value ? ocorrenciaField.value.split(' ') : [];
    const text = cb.dataset.text;
    if(cb.checked) lines.push(text);
    else { const i=lines.indexOf(text); if(i>=0) lines.splice(i,1); }
    ocorrenciaField.value = lines.join(' ');
  });
});
</script>
</body>
</html>




